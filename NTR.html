<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Translation Reviewer: Human at the Core</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36D399',
                        warning: '#FFAB00',
                        danger: '#F87272',
                        dark: '#1E293B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                },
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .text-shadow {
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .bg-blur {
        backdrop-filter: blur(8px);
      }
    }
  </style>
</head>

<body class="font-inter bg-slate-50 text-slate-800 min-h-screen flex flex-col">
    <!-- 顶部导航栏 -->
    <header class="bg-white shadow-md sticky top-0 z-50 transition-all duration-300" id="navbar">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <i class="fa fa-graduation-cap text-primary text-2xl"></i>
                <h1 class="text-xl font-bold text-primary">Nexus Translation Reviewer: Human at the Core</h1>
            </div>
            <div class="flex items-center space-x-4">
                <button id="exportBtn" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg shadow-md transition-all duration-300 flex items-center">
                    <i class="fa fa-download mr-2"></i>导出Excel
                </button>
                <button id="clearBtn" class="bg-danger hover:bg-danger/90 text-white px-4 py-2 rounded-lg shadow-md transition-all duration-300 flex items-center">
                    <i class="fa fa-trash mr-2"></i>清空缓存
                </button>
            </div>
        </div>
    </header>

    <!-- 主要内容区 -->
    <main class="flex-grow container mx-auto px-4 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            <!-- 左侧内容 -->
            <div id="leftCol" class="lg:col-span-3 space-y-8 transition-all duration-300">
                <!-- 表单卡片 -->
                <div class="bg-white rounded-xl shadow-lg p-6 transform transition-all duration-300 hover:shadow-xl">
                    <h2 class="text-2xl font-bold mb-6 text-dark flex items-center">
                        <i class="fa fa-file-text-o text-primary mr-2"></i>准备好和译文共舞了吗？
                        <span class="ml-3 text-sm font-normal text-slate-500" id="savedStatus"></span>
                    </h2>

                    <form id="assignmentForm" class="space-y-6">
                        <!-- 基本信息 -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label for="studentName" class="block text-sm font-medium text-slate-700">君の名は。</label>
                                <input type="text" id="studentName" name="studentName" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300" placeholder="请输入语料编号或名称" value="">
                            </div>
                            <div class="space-y-2">
                                <label for="language" class="block text-sm font-medium text-slate-700">语种</label>
                                <input type="text" id="language" name="language" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300" placeholder="例如：英语、日语、法语等" value="">
                            </div>
                            <div class="space-y-2">
                                <label for="score" class="block text-sm font-medium text-slate-700">评分 (1-5)</label>
                                <div class="flex items-center space-x-1">
                                    <input type="number" id="score" name="score" min="1" max="5" value="" class="w-16 px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300">
                                    <div class="flex text-warning" id="scoreDisplay">
                                        <i class="fa fa-star"></i>
                                        <i class="fa fa-star"></i>
                                        <i class="fa fa-star"></i>
                                        <i class="fa fa-star"></i>
                                        <i class="fa fa-star-o"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 作业内容 -->
                        <div class="space-y-6">
                            <!-- 原文区域（添加文件上传功能） -->
                            <div class="space-y-2">
                                <div class="flex justify-between items-center">
                                    <label for="originalQuestion" class="block text-sm font-medium text-slate-700">原文</label>
                                    <div class="flex items-center">
                                        <label for="originalQuestionFile" class="cursor-pointer bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-1 text-sm rounded-lg transition-colors flex items-center">
                                            <i class="fa fa-upload mr-1"></i>上传文件
                                        </label>
                                        <input type="file" id="originalQuestionFile" accept=".txt" class="hidden" />
                                        <span id="originalQuestionFileName" class="ml-2 text-xs text-slate-500"></span>
                                    </div>
                                </div>
                                <textarea id="originalQuestion" name="originalQuestion" rows="3" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300 resize-none" placeholder="请输入作业原文或上传文件"></textarea>
                                <p class="text-xs text-slate-500">支持TXT文件上传，自动识别Unicode编码内容</p>
                            </div>

                            <!-- 修订译文区域（添加文件上传功能） -->
                            <div class="space-y-2">
                                <div class="flex justify-between items-center">
                                    <label for="standardAnswer" class="block text-sm font-medium text-slate-700">修订译文</label>
                                    <div class="flex items-center">
                                        <label for="standardAnswerFile" class="cursor-pointer bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-1 text-sm rounded-lg transition-colors flex items-center">
                                            <i class="fa fa-upload mr-1"></i>上传文件
                                        </label>
                                        <input type="file" id="standardAnswerFile" accept=".txt" class="hidden" />
                                        <span id="standardAnswerFileName" class="ml-2 text-xs text-slate-500"></span>
                                    </div>
                                </div>
                                <textarea id="standardAnswer" name="standardAnswer" rows="3" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300 resize-none" placeholder="请输入修订译文或上传文件"></textarea>
                                <p class="text-xs text-slate-500">支持TXT文件上传，自动识别Unicode编码内容</p>
                            </div>

                            <!-- 机翻和批注列表 -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="md:col-span-2 space-y-2">
                                    <div class="flex justify-between items-center">
                                        <label for="studentAnswer" class="block text-sm font-medium text-slate-700">待修订译文 <span class="text-xs text-slate-500">(选中文本可添加批注)</span></label>
                                        <div class="flex items-center">
                                            <label for="studentAnswerFile" class="cursor-pointer bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-1 text-sm rounded-lg transition-colors flex items-center">
                                                <i class="fa fa-upload mr-1"></i>上传文件
                                            </label>
                                            <input type="file" id="studentAnswerFile" accept=".txt" class="hidden" />
                                            <span id="studentAnswerFileName" class="ml-2 text-xs text-slate-500"></span>
                                        </div>
                                    </div>
                                    <div id="studentAnswerContainer" class="relative">
                                        <textarea id="studentAnswer" name="studentAnswer" rows="10" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300 resize-none" placeholder="请输入待修订译文或上传文件"></textarea>
                                        <div id="annotationTooltip" class="hidden fixed bg-white rounded-lg shadow-lg p-3 z-40 w-64 border border-slate-200 right-4 top-1/2 -translate-y-1/2">
                                            <!-- 新增：赞/批改选择 -->
                                            <div id="feedbackTypeSelection" class="space-y-3">
                                                <h4 class="font-medium text-slate-800 mb-2">选择反馈类型</h4>
                                                <div class="grid grid-cols-2 gap-3">
                                                    <button type="button" id="likeBtn" class="p-3 border border-green-200 bg-green-50 text-green-800 rounded-lg cursor-pointer hover:bg-green-100 transition-colors flex items-center justify-center">
                                                        <i class="fa fa-thumbs-up mr-2"></i>
                                                        <span>赞</span>
                                                    </button>
                                                    <button type="button" id="dislikeBtn" class="p-3 border border-red-200 bg-red-50 text-red-800 rounded-lg cursor-pointer hover:bg-red-100 transition-colors flex items-center justify-center">
                                                        <i class="fa fa-thumbs-down mr-2"></i>
                                                        <span>批改</span>
                                                    </button>
                                                </div>
                                            </div>

                                            <!-- 缺陷类型选择（初始隐藏） -->
                                            <div id="defectTypeSelection" class="hidden space-y-3">
                                                <h4 class="font-medium text-slate-800 mb-2">选中的文本</h4>
                                                <p id="selectedText" class="text-sm bg-slate-100 p-2 rounded mb-3 break-words max-h-20 overflow-auto scrollbar-hide"></p>
                                                <p class="text-xs text-slate-500 mb-2">起始位置: <span id="selectedTextPosition">0</span></p>
                                                <label class="block text-sm font-medium text-slate-700 mb-2">缺陷类型</label>

                                                <!-- 缺陷类型分类 -->
                                                <div class="space-y-3 mb-3">
                                                    <div>
                                                        <span class="text-xs font-medium text-slate-500 block mb-1">流利度问题</span>
                                                        <div class="grid grid-cols-3 gap-2">
                                                            <label class="flex items-center justify-center p-2 border border-slate-200 rounded cursor-pointer hover:bg-slate-50 transition-colors">
                                                                <input type="radio" name="defectType" value="语法" class="mr-1 accent-primary">
                                                                <span class="text-xs">语法</span>
                                                            </label>
                                                            <label class="flex items-center justify-center p-2 border border-slate-200 rounded cursor-pointer hover:bg-slate-50 transition-colors">
                                                                <input type="radio" name="defectType" value="搭配等表达贴切度" class="mr-1 accent-primary">
                                                                <span class="text-xs">搭配等表达贴切度</span>
                                                            </label>
                                                            <label class="flex items-center justify-center p-2 border border-slate-200 rounded cursor-pointer hover:bg-slate-50 transition-colors">
                                                                <input type="radio" name="defectType" value="语序" class="mr-1 accent-primary">
                                                                <span class="text-xs">语序</span>
                                                            </label>
                                                            <label class="flex items-center justify-center p-2 border border-slate-200 rounded cursor-pointer hover:bg-slate-50 transition-colors">
                                                                <input type="radio" name="defectType" value="拼写、格式、标点" class="mr-1 accent-primary">
                                                                <span class="text-xs">拼写、格式、标点</span>
                                                            </label>
                                                            <label class="flex items-center justify-center p-2 border border-slate-200 rounded cursor-pointer hover:bg-slate-50 transition-colors">
                                                                <input type="radio" name="defectType" value="重复、内容多余" class="mr-1 accent-primary">
                                                                <span class="text-xs">重复、内容多余</span>
                                                            </label>
                                                        </div>
                                                    </div>

                                                    <div>
                                                        <span class="text-xs font-medium text-slate-500 block mb-1">忠实度</span>
                                                        <div class="grid grid-cols-3 gap-2">
                                                            <label class="flex items-center justify-center p-2 border border-slate-200 rounded cursor-pointer hover:bg-slate-50 transition-colors">
                                                                <input type="radio" name="defectType" value="错译" class="mr-1 accent-primary">
                                                                <span class="text-xs">错译</span>
                                                            </label>
                                                            <label class="flex items-center justify-center p-2 border border-slate-200 rounded cursor-pointer hover:bg-slate-50 transition-colors">
                                                                <input type="radio" name="defectType" value="漏译" class="mr-1 accent-primary">
                                                                <span class="text-xs">漏译</span>
                                                            </label>
                                                            <label class="flex items-center justify-center p-2 border border-slate-200 rounded cursor-pointer hover:bg-slate-50 transition-colors">
                                                                <input type="radio" name="defectType" value="添译" class="mr-1 accent-primary">
                                                                <span class="text-xs">添译</span>
                                                            </label>
                                                            <label class="flex items-center justify-center p-2 border border-slate-200 rounded cursor-pointer hover:bg-slate-50 transition-colors">
                                                                <input type="radio" name="defectType" value="术语翻译准确性问题" class="mr-1 accent-primary">
                                                                <span class="text-xs">术语翻译准确性问题</span>
                                                            </label>
                                                            <label class="flex items-center justify-center p-2 border border-slate-200 rounded cursor-pointer hover:bg-slate-50 transition-colors">
                                                                <input type="radio" name="defectType" value="风格与跨文化表达转换问题" class="mr-1 accent-primary">
                                                                <span class="text-xs">风格与跨文化表达转换问题</span>
                                                            </label>
                                                            <label class="flex items-center justify-center p-2 border border-slate-200 rounded cursor-pointer hover:bg-slate-50 transition-colors">
                                                                <input type="radio" name="defectType" value="其他" class="mr-1 accent-primary">
                                                                <span class="text-xs">其他</span>
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="flex justify-end space-x-2">
                                                    <button type="button" id="backToFeedbackType" class="px-3 py-1 text-sm border border-slate-300 rounded hover:bg-slate-50 transition-colors">返回</button>
                                                    <button type="button" id="saveAnnotation" class="px-3 py-1 text-sm bg-primary text-white rounded hover:bg-primary/90 transition-colors">保存</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <p class="text-xs text-slate-500">支持TXT文件上传，自动识别Unicode编码内容</p>
                                </div>

                                <div class="space-y-2">
                                    <div class="flex items-center justify-between">
                                        <label class="block text-sm font-medium text-slate-700">批注列表</label>
                                        <span id="annotationCount" class="text-xs text-slate-500">0 条批注</span>
                                    </div>
                                    <div id="annotationList" class="border border-slate-200 rounded-lg max-h-[420px] overflow-auto scrollbar-hide">
                                        <div class="p-4 text-center text-slate-400 text-sm">暂无批注</div>
                                    </div>
                                </div>
                            </div>

                            <div class="space-y-2">
                                <label for="comments" class="block text-sm font-medium text-slate-700">评语</label>
                                <textarea id="comments" name="comments" rows="3" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300 resize-none" placeholder="请输入评语"></textarea>
                            </div>
                        </div>

                        <!-- 保存/编辑按钮区域 -->
                        <div class="flex justify-end space-x-3">
                            <button type="button" id="cancelEditAssignmentBtn" class="px-6 py-3 border border-slate-300 text-slate-700 rounded-lg shadow-md transition-all duration-300 hidden">
                                取消编辑
                            </button>
                            <button type="button" id="saveFormBtn" class="px-6 py-3 bg-primary hover:bg-primary/90 text-white rounded-lg shadow-md transition-all duration-300 flex items-center">
                                <i class="fa fa-save mr-2"></i><span id="saveFormBtnText">保存作业</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 右侧内容 - 历史记录 -->
            <div id="rightCol" class="lg:col-span-2 transition-all duration-300">
                <div class="bg-white rounded-xl shadow-lg p-6 h-full transform transition-all duration-300 hover:shadow-xl sticky top-24">
                    <h2 class="text-2xl font-bold mb-6 text-dark flex items-center">
                        <i class="fa fa-history text-primary mr-2"></i>历史记录
                        <span class="ml-3 text-sm font-normal text-slate-500" id="historyCount">0 条记录</span>
                        <button id="collapseHistoryBtn" class="ml-auto text-slate-400 hover:text-slate-600 transition-colors text-sm flex items-center">
                            <span class="mr-1">收起</span>
                            <i class="fa fa-chevron-right"></i>
                        </button>
                    </h2>

                    <div class="overflow-x-auto lg:overflow-x-visible">
                        <table class="min-w-full divide-y divide-slate-200">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">语料名称</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">语种</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">评分</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">操作</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody" class="bg-white divide-y divide-slate-200">
                                <tr>
                                    <td colspan="3" class="px-6 py-8 text-center text-slate-400">暂无保存的作业记录</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 折叠后用于展开历史记录的浮动按钮 -->
            <button id="expandHistoryBtn" class="hidden fixed right-4 top-1/2 -translate-y-1/2 bg-white border border-slate-200 shadow-lg rounded-l-lg px-3 py-2 text-sm text-slate-600 hover:text-slate-800 z-40 flex items-center">
                <i class="fa fa-chevron-left mr-1"></i><span>展开历史</span>
            </button>
        </div>
    </main>

    <!-- 编辑批注模态框 -->
    <div id="editAnnotationModal" class="fixed inset-0 bg-black/50 bg-blur z-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md mx-4 transform scale-95 transition-transform duration-300">
            <div class="p-6 border-b border-slate-200">
                <h3 class="text-lg font-bold text-slate-800">编辑批注</h3>
            </div>
            <div class="p-6 space-y-4">
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-slate-700">批注文本</label>
                    <p id="editSelectedText" class="bg-slate-100 p-3 rounded break-words"></p>
                    <p class="text-xs text-slate-500">起始位置: <span id="editTextPosition">0</span></p>
                </div>
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-slate-700">缺陷类型</label>

                    <!-- 编辑模态框中的缺陷类型分类 -->
                    <div class="space-y-3">
                        <div>
                            <span class="text-xs font-medium text-slate-500 block mb-1">流利度</span>
                            <div class="grid grid-cols-3 gap-2">
                                <label class="flex items-center justify-center p-2 border border-slate-200 rounded cursor-pointer hover:bg-slate-50 transition-colors">
                                    <input type="radio" name="editDefectType" value="语法" class="mr-1 accent-primary">
                                    <span class="text-xs">语法</span>
                                </label>
                                <label class="flex items-center justify-center p-2 border border-slate-200 rounded cursor-pointer hover:bg-slate-50 transition-colors">
                                    <input type="radio" name="editDefectType" value="搭配等表达贴切度" class="mr-1 accent-primary">
                                    <span class="text-xs">搭配等表达贴切度</span>
                                </label>
                                <label class="flex items-center justify-center p-2 border border-slate-200 rounded cursor-pointer hover:bg-slate-50 transition-colors">
                                    <input type="radio" name="editDefectType" value="语序" class="mr-1 accent-primary">
                                    <span class="text-xs">语序</span>
                                </label>
                                <label class="flex items-center justify-center p-2 border border-slate-200 rounded cursor-pointer hover:bg-slate-50 transition-colors">
                                    <input type="radio" name="editDefectType" value="拼写、格式、标点" class="mr-1 accent-primary">
                                    <span class="text-xs">拼写、格式、标点</span>
                                </label>
                                <label class="flex items-center justify-center p-2 border border-slate-200 rounded cursor-pointer hover:bg-slate-50 transition-colors">
                                    <input type="radio" name="editDefectType" value="拼写、格式、标点" class="mr-1 accent-primary">
                                    <span class="text-xs">重复、内容多余</span>
                                </label>
                            </div>
                        </div>

                        <div>
                            <span class="text-xs font-medium text-slate-500 block mb-1">忠实度</span>
                            <div class="grid grid-cols-3 gap-2">
                                <label class="flex items-center justify-center p-2 border border-slate-200 rounded cursor-pointer hover:bg-slate-50 transition-colors">
                                    <input type="radio" name="editDefectType" value="错译" class="mr-1 accent-primary">
                                    <span class="text-xs">错译</span>
                                </label>
                                <label class="flex items-center justify-center p-2 border border-slate-200 rounded cursor-pointer hover:bg-slate-50 transition-colors">
                                    <input type="radio" name="editDefectType" value="漏译" class="mr-1 accent-primary">
                                    <span class="text-xs">漏译</span>
                                </label>
                                <label class="flex items-center justify-center p-2 border border-slate-200 rounded cursor-pointer hover:bg-slate-50 transition-colors">
                                    <input type="radio" name="editDefectType" value="添译" class="mr-1 accent-primary">
                                    <span class="text-xs">添译</span>
                                </label>
                                <label class="flex items-center justify-center p-2 border border-slate-200 rounded cursor-pointer hover:bg-slate-50 transition-colors">
                                    <input type="radio" name="editDefectType" value="术语翻译准确性问题" class="mr-1 accent-primary">
                                    <span class="text-xs">术语翻译准确性问题</span>
                                </label>
                                <label class="flex items-center justify-center p-2 border border-slate-200 rounded cursor-pointer hover:bg-slate-50 transition-colors">
                                    <input type="radio" name="editDefectType" value="风格与跨文化表达转换问题" class="mr-1 accent-primary">
                                    <span class="text-xs">风格与跨文化表达转换问题</span>
                                </label>
                                <label class="flex items-center justify-center p-2 border border-slate-200 rounded cursor-pointer hover:bg-slate-50 transition-colors">
                                    <input type="radio" name="editDefectType" value="其他" class="mr-1 accent-primary">
                                    <span class="text-xs">其他</span>
                                </label>
                            </div>
                        </div>

                        <div>
                            <span class="text-xs font-medium text-slate-500 block mb-1">其他问题</span>
                            <div class="grid grid-cols-3 gap-2">
                                <label class="flex items-center justify-center p-2 border border-slate-200 rounded cursor-pointer hover:bg-slate-50 transition-colors">
                                    <input type="radio" name="editDefectType" value="格式错误" class="mr-1 accent-primary">
                                    <span class="text-xs">格式错误</span>
                                </label>
                                <label class="flex items-center justify-center p-2 border border-slate-200 rounded cursor-pointer hover:bg-slate-50 transition-colors">
                                    <input type="radio" name="editDefectType" value="标点错误" class="mr-1 accent-primary">
                                    <span class="text-xs">标点错误</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t border-slate-200 flex justify-end space-x-3">
                <button id="cancelEditBtn" class="px-4 py-2 border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors">取消</button>
                <button id="saveEditBtn" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">保存修改</button>
            </div>
        </div>
    </div>

    <!-- 查看作业详情模态框 -->
    <div id="viewAssignmentModal" class="fixed inset-0 bg-black/50 bg-blur z-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-4xl mx-4 max-h-[90vh] flex flex-col transform scale-95 transition-transform duration-300">
            <div class="p-6 border-b border-slate-200 flex justify-between items-center">
                <h3 class="text-lg font-bold text-slate-800">作业详情</h3>
                <span id="viewSavedTime" class="text-sm text-slate-500"></span>
            </div>
            <div class="p-6 overflow-y-auto">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <h4 class="font-medium text-slate-700 mb-2">语料名称</h4>
                        <p id="viewStudentName" class="bg-slate-100 p-3 rounded"></p>
                    </div>
                    <div>
                        <h4 class="font-medium text-slate-700 mb-2">语种</h4>
                        <p id="viewLanguage" class="bg-slate-100 p-3 rounded"></p>
                    </div>
                    <div>
                        <h4 class="font-medium text-slate-700 mb-2">评分</h4>
                        <div id="viewScoreDisplay" class="bg-slate-100 p-3 rounded flex text-warning"></div>
                    </div>
                </div>

                <div class="space-y-6">
                    <div>
                        <h4 class="font-medium text-slate-700 mb-2">原文</h4>
                        <p id="viewOriginalQuestion" class="bg-slate-100 p-3 rounded whitespace-pre-wrap"></p>
                    </div>

                    <div>
                        <h4 class="font-medium text-slate-700 mb-2">修订译文</h4>
                        <p id="viewStandardAnswer" class="bg-slate-100 p-3 rounded whitespace-pre-wrap"></p>
                    </div>

                    <div>
                        <h4 class="font-medium text-slate-700 mb-2">待修订译文</h4>
                        <p id="viewStudentAnswer" class="bg-slate-100 p-3 rounded whitespace-pre-wrap"></p>
                    </div>

                    <div>
                        <h4 class="font-medium text-slate-700 mb-2">评语</h4>
                        <p id="viewComments" class="bg-slate-100 p-3 rounded whitespace-pre-wrap"></p>
                    </div>

                    <div>
                        <h4 class="font-medium text-slate-700 mb-2">批注列表</h4>
                        <div id="viewAnnotationList" class="space-y-3">
                            <div class="text-center text-slate-400 text-sm py-4">无批注</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t border-slate-200 flex justify-end">
                <button id="closeViewBtn" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">关闭</button>
            </div>
        </div>
    </div>

    <!-- 通知组件 -->
    <div id="notification" class="fixed bottom-4 right-4 bg-white rounded-lg shadow-lg p-4 transform translate-y-20 opacity-0 transition-all duration-500 flex items-start z-50 max-w-sm">
        <div id="notificationIcon" class="mr-3 text-lg"></div>
        <div class="flex-1">
            <h4 id="notificationTitle" class="font-medium text-slate-800"></h4>
            <p id="notificationMessage" class="text-sm text-slate-600 mt-1"></p>
        </div>
        <button id="closeNotification" class="ml-3 text-slate-400 hover:text-slate-600">
            <i class="fa fa-times"></i>
        </button>
    </div>

    <script>
        // 存储当前编辑的批注索引
        let currentEditIndex = null;
        // 存储当前查看的作业索引
        let currentViewIndex = null;
        // 批注数据
        let annotations = [];
        // 存储选中文字的起始和结束索引
        let selectedTextRange = {
            start: 0,
            end: 0
        };
        // 历史记录数据
        let historyAssignments = [];
        // 正在编辑的历史记录索引（null 表示新建）
        let editingAssignmentIndex = null;

        // DOM 元素
        const scoreInput = document.getElementById('score');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const studentAnswer = document.getElementById('studentAnswer');
        const annotationTooltip = document.getElementById('annotationTooltip');
        const feedbackTypeSelection = document.getElementById('feedbackTypeSelection');
        const defectTypeSelection = document.getElementById('defectTypeSelection');
        const selectedText = document.getElementById('selectedText');
        const selectedTextPosition = document.getElementById('selectedTextPosition');
        const likeBtn = document.getElementById('likeBtn');
        const dislikeBtn = document.getElementById('dislikeBtn');
        const backToFeedbackType = document.getElementById('backToFeedbackType');
        const saveAnnotationBtn = document.getElementById('saveAnnotation');
        const annotationList = document.getElementById('annotationList');
        const annotationCount = document.getElementById('annotationCount');
        const saveFormBtn = document.getElementById('saveFormBtn');
        const savedStatus = document.getElementById('savedStatus');
        const historyTableBody = document.getElementById('historyTableBody');
        const historyCount = document.getElementById('historyCount');
        const exportBtn = document.getElementById('exportBtn');
        const clearBtn = document.getElementById('clearBtn');
        const editAnnotationModal = document.getElementById('editAnnotationModal');
        const editSelectedText = document.getElementById('editSelectedText');
        const editTextPosition = document.getElementById('editTextPosition');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const saveEditBtn = document.getElementById('saveEditBtn');
        const cancelEditAssignmentBtn = document.getElementById('cancelEditAssignmentBtn');
        const saveFormBtnText = document.getElementById('saveFormBtnText');
        const viewAssignmentModal = document.getElementById('viewAssignmentModal');
        const viewSavedTime = document.getElementById('viewSavedTime');
        const viewStudentName = document.getElementById('viewStudentName');
        const viewScoreDisplay = document.getElementById('viewScoreDisplay');
        const viewOriginalQuestion = document.getElementById('viewOriginalQuestion');
        const viewStandardAnswer = document.getElementById('viewStandardAnswer');
        const viewStudentAnswer = document.getElementById('viewStudentAnswer');
        const viewComments = document.getElementById('viewComments');
        const viewAnnotationList = document.getElementById('viewAnnotationList');
        const closeViewBtn = document.getElementById('closeViewBtn');
        const notification = document.getElementById('notification');
        const notificationIcon = document.getElementById('notificationIcon');
        const notificationTitle = document.getElementById('notificationTitle');
        const notificationMessage = document.getElementById('notificationMessage');
        const closeNotification = document.getElementById('closeNotification');
        const navbar = document.getElementById('navbar');
        const rightCol = document.getElementById('rightCol');
        const leftCol = document.getElementById('leftCol');
        const collapseHistoryBtn = document.getElementById('collapseHistoryBtn');
        const expandHistoryBtn = document.getElementById('expandHistoryBtn');

        // 文件上传相关元素
        const originalQuestionFile = document.getElementById('originalQuestionFile');
        const originalQuestionFileName = document.getElementById('originalQuestionFileName');
        const standardAnswerFile = document.getElementById('standardAnswerFile');
        const standardAnswerFileName = document.getElementById('standardAnswerFileName');
        const studentAnswerFile = document.getElementById('studentAnswerFile');
        const studentAnswerFileName = document.getElementById('studentAnswerFileName');
        const originalQuestion = document.getElementById('originalQuestion');
        const standardAnswer = document.getElementById('standardAnswer');

        // 初始化
        function init() {
            // 设置缺陷类型样式映射
            window.defectTypeStyles = {
                // 赞
                '赞': {
                    class: 'bg-green-100 text-green-800',
                    icon: 'fa-thumbs-up'
                },

                // 翻译准确性问题
                '错译': {
                    class: 'bg-red-100 text-red-800',
                    icon: 'fa-times-circle'
                },
                '漏译': {
                    class: 'bg-orange-100 text-orange-800',
                    icon: 'fa-minus-circle'
                },
                '多译': {
                    class: 'bg-purple-100 text-purple-800',
                    icon: 'fa-plus-circle'
                },

                // 语言表达问题
                '语法问题': {
                    class: 'bg-yellow-100 text-yellow-800',
                    icon: 'fa-exclamation-circle'
                },
                '用词不当': {
                    class: 'bg-blue-100 text-blue-800',
                    icon: 'fa-question-circle'
                },
                '表达不自然': {
                    class: 'bg-indigo-100 text-indigo-800',
                    icon: 'fa-meh-o'
                },

                // 其他问题
                '格式错误': {
                    class: 'bg-green-100 text-green-800',
                    icon: 'fa-th-large'
                },
                '标点错误': {
                    class: 'bg-gray-100 text-gray-800',
                    icon: 'fa-pencil'
                }
            };

            // 加载历史记录
            loadHistory();

            // 加载当前表单数据（如果有）
            loadCurrentFormData();

            // 事件监听器
            scoreInput.addEventListener('input', updateScoreDisplay);
            studentAnswer.addEventListener('mouseup', handleTextSelection);
            likeBtn.addEventListener('click', handleLikeSelection);
            dislikeBtn.addEventListener('click', handleDislikeSelection);
            backToFeedbackType.addEventListener('click', showFeedbackTypeSelection);
            saveAnnotationBtn.addEventListener('click', handleSaveAnnotation);
            saveFormBtn.addEventListener('click', handleSaveForm);
            exportBtn.addEventListener('click', exportToExcel);
            clearBtn.addEventListener('click', clearHistory);
            cancelEditBtn.addEventListener('click', hideEditModal);
            saveEditBtn.addEventListener('click', handleEditAnnotation);
            collapseHistoryBtn.addEventListener('click', collapseHistoryPanel);
            expandHistoryBtn.addEventListener('click', expandHistoryPanel);
            cancelEditAssignmentBtn.addEventListener('click', handleCancelEditAssignment);
            viewAssignmentModal.addEventListener('click', (e) => {
                if (e.target === viewAssignmentModal) hideViewModal();
            });
            closeViewBtn.addEventListener('click', hideViewModal);
            closeNotification.addEventListener('click', hideNotification);

            // 文件上传事件监听器
            originalQuestionFile.addEventListener('change', (e) => handleFileUpload(e, originalQuestion, originalQuestionFileName));
            standardAnswerFile.addEventListener('change', (e) => handleFileUpload(e, standardAnswer, standardAnswerFileName));
            studentAnswerFile.addEventListener('change', (e) => handleFileUpload(e, studentAnswer, studentAnswerFileName));

            // 滚动事件处理导航栏样式
            window.addEventListener('scroll', () => {
                if (window.scrollY > 10) {
                    navbar.classList.add('py-2', 'shadow-lg');
                    navbar.classList.remove('py-3', 'shadow-md');
                } else {
                    navbar.classList.add('py-3', 'shadow-md');
                    navbar.classList.remove('py-2', 'shadow-lg');
                }
            });
        }

        function collapseHistoryPanel() {
            // 右侧隐藏，左侧扩大
            rightCol.classList.add('hidden');
            // 在大屏时占据 5 列（整个栅格）
            leftCol.classList.remove('lg:col-span-3');
            leftCol.classList.add('lg:col-span-5');
            expandHistoryBtn.classList.remove('hidden');
        }

        function expandHistoryPanel() {
            rightCol.classList.remove('hidden');
            leftCol.classList.remove('lg:col-span-5');
            leftCol.classList.add('lg:col-span-3');
            expandHistoryBtn.classList.add('hidden');
        }

        // 处理文件上传
        function handleFileUpload(event, targetTextarea, fileNameDisplay) {
            const file = event.target.files[0];
            if (!file) return;

            // 显示文件名
            fileNameDisplay.textContent = file.name;

            // 检查文件类型
            if (!file.name.endsWith('.txt')) {
                showNotification('错误', '请上传TXT格式的文件', 'error');
                return;
            }

            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    targetTextarea.value = e.target.result;
                    showNotification('成功', `文件内容已加载`, 'success');

                    // 保存当前表单数据
                    saveCurrentFormData();
                } catch (error) {
                    showNotification('错误', `文件读取失败: ${error.message}`, 'error');
                    console.error('文件读取错误:', error);
                }
            };

            reader.onerror = function() {
                showNotification('错误', '文件读取失败，请尝试其他文件', 'error');
                console.error('文件读取错误:', reader.error);
            };

            // 以文本方式读取文件
            reader.readAsText(file);
        }

        // 更新评分显示
        function updateScoreDisplay() {
            const score = parseInt(scoreInput.value);
            scoreDisplay.innerHTML = '';

            for (let i = 1; i <= 5; i++) {
                const star = document.createElement('i');
                star.className = i <= score ? 'fa fa-star' : 'fa fa-star-o';
                scoreDisplay.appendChild(star);
            }
        }

        // 处理文本选择
        function handleTextSelection() {
            // 检查编辑弹窗是否打开，如果打开则不处理文本选择
            const isEditModalOpen = !editAnnotationModal.classList.contains('opacity-0');
            if (isEditModalOpen) {
                return;
            }

            const selection = window.getSelection();
            const selectedTextContent = selection.toString().trim();

            if (selectedTextContent.length > 0) {
                // 获取选中文本的位置和范围
                // 不再根据选区的位置定位弹窗，固定在屏幕中间右侧

                // 获取选中文本的起始和结束索引
                const textBeforeSelection = studentAnswer.value.substring(0, studentAnswer.selectionStart);
                selectedTextRange = {
                    start: studentAnswer.selectionStart,
                    end: studentAnswer.selectionEnd
                };

                // 显示选中文本的起始位置
                selectedTextPosition.textContent = selectedTextRange.start;

                // 显示批注工具提示
                selectedText.textContent = selectedTextContent;
                // 固定定位：屏幕中间右侧
                annotationTooltip.style.right = '1rem';
                annotationTooltip.style.top = '50%';
                annotationTooltip.style.left = '';
                annotationTooltip.style.transform = 'translateY(-50%)';
                annotationTooltip.classList.remove('hidden');

                // 重置缺陷类型选择
                document.querySelectorAll('input[name="defectType"]').forEach(radio => {
                    radio.checked = false;
                });

                // 显示反馈类型选择界面
                showFeedbackTypeSelection();
            } else {
                hideAnnotationTooltip();
            }
        }

        // 显示反馈类型选择
        function showFeedbackTypeSelection() {
            feedbackTypeSelection.classList.remove('hidden');
            defectTypeSelection.classList.add('hidden');
        }

        // 显示缺陷类型选择
        function showDefectTypeSelection() {
            feedbackTypeSelection.classList.add('hidden');
            defectTypeSelection.classList.remove('hidden');
        }

        // 处理"赞"选择
        function handleLikeSelection() {
            // 直接保存为"赞"类型的批注，包含起始位置
            annotations.push({
                text: selectedText.textContent,
                type: '赞',
                startPosition: selectedTextRange.start, // 记录起始位置
                range: {
                    ...selectedTextRange
                }
            });

            // 保存当前表单数据
            saveCurrentFormData();

            // 更新批注列表
            renderAnnotations();

            // 隐藏工具提示
            hideAnnotationTooltip();

            showNotification('成功', '已添加"赞"批注', 'success');
        }

        // 处理"批改"选择
        function handleDislikeSelection() {
            // 显示缺陷类型选择界面
            showDefectTypeSelection();
        }

        // 隐藏批注工具提示
        function hideAnnotationTooltip() {
            annotationTooltip.classList.add('hidden');
        }

        // 处理保存批注
        function handleSaveAnnotation() {
            const defectType = document.querySelector('input[name="defectType"]:checked');

            if (!defectType) {
                showNotification('错误', '请选择缺陷类型', 'error');
                return;
            }

            annotations.push({
                text: selectedText.textContent,
                type: defectType.value,
                startPosition: selectedTextRange.start, // 记录起始位置
                range: {
                    ...selectedTextRange
                }
            });

            // 保存当前表单数据
            saveCurrentFormData();

            // 更新批注列表
            renderAnnotations();

            // 隐藏工具提示
            hideAnnotationTooltip();

            showNotification('成功', '批注已添加', 'success');
        }

        // 渲染批注列表
        function renderAnnotations() {
            annotationList.innerHTML = '';

            if (annotations.length === 0) {
                annotationList.innerHTML = '<div class="p-4 text-center text-slate-400 text-sm">暂无批注</div>';
                annotationCount.textContent = '0 条批注';
                return;
            }

            annotationCount.textContent = `${annotations.length} 条批注`;

            annotations.forEach((annotation, index) => {
                const style = window.defectTypeStyles[annotation.type] || {
                    class: 'bg-slate-100 text-slate-800',
                    icon: 'fa-circle'
                };

                const item = document.createElement('div');
                item.className = 'p-3 border-b border-slate-100 hover:bg-slate-50 transition-colors flex items-start';

                item.innerHTML = `
          <div class="flex-shrink-0 mr-3 mt-0.5">
            <span class="inline-flex items-center justify-center w-6 h-6 rounded-full ${style.class}">
              <i class="fa ${style.icon} text-xs"></i>
            </span>
          </div>
          <div class="flex-grow">
            <div class="flex justify-between">
              <span class="text-xs font-medium ${style.class} px-2 py-0.5 rounded">${annotation.type}</span>
              <div class="flex space-x-1">
                <button class="edit-annotation text-slate-400 hover:text-primary transition-colors" data-index="${index}">
                  <i class="fa fa-pencil"></i>
                </button>
                <button class="delete-annotation text-slate-400 hover:text-danger transition-colors" data-index="${index}">
                  <i class="fa fa-trash"></i>
                </button>
              </div>
            </div>
            <p class="text-sm mt-1 break-words">${annotation.text}</p>
            <!-- 显示起始位置 -->
            <p class="text-xs text-slate-400 mt-1">起始位置: ${annotation.startPosition}</p>
          </div>
        `;

                annotationList.appendChild(item);
            });

            // 添加编辑和删除事件监听器
            document.querySelectorAll('.edit-annotation').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.dataset.index);
                    openEditModal(index);
                });
            });

            document.querySelectorAll('.delete-annotation').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.dataset.index);
                    deleteAnnotation(index);
                });
            });
        }

        // 打开编辑模态框
        function openEditModal(index) {
            currentEditIndex = index;
            const annotation = annotations[index];

            editSelectedText.textContent = annotation.text;
            // 显示批注的起始位置
            editTextPosition.textContent = annotation.startPosition;

            // 设置当前选择的缺陷类型
            document.querySelectorAll('input[name="editDefectType"]').forEach(radio => {
                radio.checked = radio.value === annotation.type;
            });

            // 显示模态框
            editAnnotationModal.classList.remove('opacity-0', 'pointer-events-none');
            editAnnotationModal.querySelector('div').classList.remove('scale-95');
            editAnnotationModal.querySelector('div').classList.add('scale-100');
        }

        // 隐藏编辑模态框
        function hideEditModal() {
            editAnnotationModal.classList.add('opacity-0', 'pointer-events-none');
            editAnnotationModal.querySelector('div').classList.remove('scale-100');
            editAnnotationModal.querySelector('div').classList.add('scale-95');
        }

        // 处理编辑批注
        function handleEditAnnotation() {
            const defectType = document.querySelector('input[name="editDefectType"]:checked');

            if (!defectType) {
                showNotification('错误', '请选择缺陷类型', 'error');
                return;
            }

            // 只更新类型，保留原始的文本和位置信息
            annotations[currentEditIndex].type = defectType.value;

            // 保存当前表单数据
            saveCurrentFormData();

            // 更新批注列表
            renderAnnotations();

            // 隐藏模态框
            hideEditModal();

            showNotification('成功', '批注已更新', 'success');
        }

        // 删除批注
        function deleteAnnotation(index) {
            if (confirm('确定要删除这条批注吗？')) {
                annotations.splice(index, 1);

                // 保存当前表单数据
                saveCurrentFormData();

                // 更新批注列表
                renderAnnotations();

                showNotification('成功', '批注已删除', 'success');
            }
        }

        // 处理保存表单
        function handleSaveForm() {
            const studentName = document.getElementById('studentName').value.trim();
            const language = document.getElementById('language').value.trim();
            const originalQuestion = document.getElementById('originalQuestion').value.trim();
            const standardAnswer = document.getElementById('standardAnswer').value.trim();
            const studentAnswer = document.getElementById('studentAnswer').value.trim();
            const score = parseInt(document.getElementById('score').value);
            const comments = document.getElementById('comments').value.trim();

            if (!studentName) {
                showNotification('错误', '请输入语料编号或名称', 'error');
                return;
            }

            if (!language) {
                showNotification('错误', '请输入语种', 'error');
                return;
            }

            if (!originalQuestion) {
                showNotification('错误', '请输入或上传作业原文', 'error');
                return;
            }

            if (!standardAnswer) {
                showNotification('错误', '请输入或上传修订译文', 'error');
                return;
            }

            if (!studentAnswer) {
                showNotification('错误', '请输入或上传待修订译文', 'error');
                return;
            }

            if (!score || score < 1 || score > 5) {
                showNotification('错误', '请输入有效的评分（1-5）', 'error');
                return;
            }

            // 获取当前时间
            const now = new Date();
            const savedTime = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;

            // 创建作业对象
            const assignment = {
                studentName,
                originalQuestion,
                standardAnswer,
                studentAnswer,
                score,
                comments,
                annotations: [...annotations], // 包含起始位置信息
                savedTime,
                language
            };

            if (editingAssignmentIndex !== null) {
                // 更新现有记录
                historyAssignments[editingAssignmentIndex] = assignment;
                localStorage.setItem('assignmentHistory', JSON.stringify(historyAssignments));
                renderHistory();

                // 退出编辑模式并重置
                editingAssignmentIndex = null;
                // 保存需要保留的字段
                const keepStudentName = document.getElementById('studentName').value;
                const keepLanguage = document.getElementById('language').value;
                const keepScore = document.getElementById('score').value;

                document.getElementById('assignmentForm').reset();
                // 还原需要保留的字段
                document.getElementById('studentName').value = keepStudentName;
                document.getElementById('language').value = keepLanguage;
                document.getElementById('score').value = keepScore;
                annotations = [];
                renderAnnotations();
                // 更新评分星星显示
                updateScoreDisplay();
                originalQuestionFileName.textContent = '';
                standardAnswerFileName.textContent = '';
                studentAnswerFileName.textContent = '';
                originalQuestionFile.value = '';
                standardAnswerFile.value = '';
                studentAnswerFile.value = '';
                localStorage.removeItem('currentAssignment');
                exitEditModeUI();
                showNotification('成功', '历史记录已更新', 'success');
                return;
            }

            // 新增记录
            historyAssignments.unshift(assignment);
            localStorage.setItem('assignmentHistory', JSON.stringify(historyAssignments));
            renderHistory();

            // 重置表单，但保留学生编号、语种和评分
            const keepStudentName = document.getElementById('studentName').value;
            const keepLanguage = document.getElementById('language').value;
            const keepScore = document.getElementById('score').value;

            document.getElementById('assignmentForm').reset();
            document.getElementById('studentName').value = keepStudentName;
            document.getElementById('language').value = keepLanguage;
            document.getElementById('score').value = keepScore;
            annotations = [];
            renderAnnotations();
            // 更新评分星星显示
            updateScoreDisplay();
            originalQuestionFileName.textContent = '';
            standardAnswerFileName.textContent = '';
            studentAnswerFileName.textContent = '';
            originalQuestionFile.value = '';
            standardAnswerFile.value = '';
            studentAnswerFile.value = '';
            localStorage.removeItem('currentAssignment');

            savedStatus.textContent = '已保存';
            savedStatus.className = 'ml-3 text-sm font-normal text-green-500';
            setTimeout(() => {
                savedStatus.textContent = ''
            }, 3000);
            showNotification('成功', '作业已保存', 'success');
        }

        // 加载历史记录
        function loadHistory() {
            const historyData = localStorage.getItem('assignmentHistory');

            if (historyData) {
                historyAssignments = JSON.parse(historyData);
                renderHistory();
            }
        }

        // 渲染历史记录
        function renderHistory() {
            historyTableBody.innerHTML = '';

            if (historyAssignments.length === 0) {
                historyTableBody.innerHTML = '<tr><td colspan="4" class="px-6 py-8 text-center text-slate-400">暂无保存的作业记录</td></tr>';
                historyCount.textContent = '0 条记录';
                return;
            }

            historyCount.textContent = `${historyAssignments.length} 条记录`;

            historyAssignments.forEach((assignment, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-slate-50 transition-colors';

                // 生成评分星星
                let starsHtml = '';
                for (let i = 1; i <= 5; i++) {
                    starsHtml += `<i class="fa fa-star${i <= assignment.score ? '' : '-o'} text-warning"></i>`;
                }

                row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="font-medium text-slate-900">${assignment.studentName}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-slate-700">${assignment.language}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex">${starsHtml}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">
            <button class="view-assignment text-primary hover:text-primary/80 transition-colors mr-3">
              <i class="fa fa-eye mr-1"></i>查看
            </button>
            <button class="edit-assignment text-slate-600 hover:text-slate-800 transition-colors mr-3">
              <i class="fa fa-pencil mr-1"></i>编辑
            </button>
            <button class="delete-assignment text-red-600 hover:text-red-800 transition-colors">
              <i class="fa fa-trash mr-1"></i>删除
            </button>
          </td>
        `;

                historyTableBody.appendChild(row);

                // 添加查看事件监听器
                const viewBtn = row.querySelector('.view-assignment');

                viewBtn.addEventListener('click', () => {
                    openViewModal(index);
                });

                // 添加编辑事件监听器
                const editBtn = row.querySelector('.edit-assignment');
                editBtn.addEventListener('click', () => {
                    startEditAssignment(index);
                });

                // 添加删除事件监听器
                const deleteBtn = row.querySelector('.delete-assignment');
                deleteBtn.addEventListener('click', () => {
                    deleteAssignment(index);
                });
            });
        }

        // 打开查看模态框
        function openViewModal(index) {
            currentViewIndex = index;
            const assignment = historyAssignments[index];

            viewSavedTime.textContent = `保存时间: ${assignment.savedTime}`;
            viewStudentName.textContent = assignment.studentName;
            viewOriginalQuestion.textContent = assignment.originalQuestion;
            viewStandardAnswer.textContent = assignment.standardAnswer;
            viewStudentAnswer.textContent = assignment.studentAnswer;
            viewComments.textContent = assignment.comments;
            viewLanguage.textContent = assignment.language;

            // 生成评分星星
            viewScoreDisplay.innerHTML = '';
            for (let i = 1; i <= 5; i++) {
                const star = document.createElement('i');
                star.className = i <= assignment.score ? 'fa fa-star text-warning' : 'fa fa-star-o text-warning';
                viewScoreDisplay.appendChild(star);
            }

            // 渲染批注列表
            viewAnnotationList.innerHTML = '';

            if (assignment.annotations && assignment.annotations.length > 0) {
                assignment.annotations.forEach(annotation => {
                    const style = window.defectTypeStyles[annotation.type] || {
                        class: 'bg-slate-100 text-slate-800',
                        icon: 'fa-circle'
                    };

                    const item = document.createElement('div');
                    item.className = 'p-3 border border-slate-200 rounded-lg';

                    item.innerHTML = `
            <div class="flex items-center mb-2">
              <span class="inline-flex items-center justify-center w-6 h-6 rounded-full ${style.class} mr-2">
                <i class="fa ${style.icon} text-xs"></i>
              </span>
              <span class="text-sm font-medium ${style.class} px-2 py-0.5 rounded">${annotation.type}</span>
            </div>
            <p class="text-sm break-words">${annotation.text}</p>
            <!-- 显示起始位置 -->
            <p class="text-xs text-slate-500 mt-1">起始位置: ${annotation.startPosition}</p>
          `;

                    viewAnnotationList.appendChild(item);
                });
            } else {
                viewAnnotationList.innerHTML = '<div class="text-center text-slate-400 text-sm py-4">无批注</div>';
            }

            // 显示模态框
            viewAssignmentModal.classList.remove('opacity-0', 'pointer-events-none');
            viewAssignmentModal.querySelector('div').classList.remove('scale-95');
            viewAssignmentModal.querySelector('div').classList.add('scale-100');
        }

        // 进入编辑模式：将某条历史记录加载到左侧表单
        function startEditAssignment(index) {
            const assignment = historyAssignments[index];
            editingAssignmentIndex = index;

            document.getElementById('studentName').value = assignment.studentName || '';
            document.getElementById('language').value = assignment.language || '';
            document.getElementById('originalQuestion').value = assignment.originalQuestion || '';
            document.getElementById('standardAnswer').value = assignment.standardAnswer || '';
            document.getElementById('studentAnswer').value = assignment.studentAnswer || '';
            document.getElementById('score').value = assignment.score || '';
            document.getElementById('comments').value = assignment.comments || '';

            annotations = Array.isArray(assignment.annotations) ? assignment.annotations.map(a => ({
                ...a
            })) : [];
            renderAnnotations();
            updateScoreDisplay();

            enterEditModeUI();

            // 保存当前表单数据快照
            saveCurrentFormData();

            // 滚动到顶部表单
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        function enterEditModeUI() {
            savedStatus.textContent = '编辑模式：正在修改历史记录';
            savedStatus.className = 'ml-3 text-sm font-normal text-yellow-500';
            saveFormBtnText.textContent = '更新作业';
            cancelEditAssignmentBtn.classList.remove('hidden');
        }

        function exitEditModeUI() {
            savedStatus.textContent = '';
            saveFormBtnText.textContent = '保存作业';
            cancelEditAssignmentBtn.classList.add('hidden');
        }

        function handleCancelEditAssignment() {
            editingAssignmentIndex = null;
            document.getElementById('assignmentForm').reset();
            annotations = [];
            renderAnnotations();
            updateScoreDisplay();
            localStorage.removeItem('currentAssignment');
            exitEditModeUI();
            showNotification('已取消', '已退出编辑模式', 'info');
        }

        // 隐藏查看模态框
        function hideViewModal() {
            viewAssignmentModal.classList.add('opacity-0', 'pointer-events-none');
            viewAssignmentModal.querySelector('div').classList.remove('scale-100');
            viewAssignmentModal.querySelector('div').classList.add('scale-95');
        }

        // 保存当前表单数据
        function saveCurrentFormData() {
            const formData = {
                studentName: document.getElementById('studentName').value,
                originalQuestion: document.getElementById('originalQuestion').value,
                standardAnswer: document.getElementById('standardAnswer').value,
                studentAnswer: document.getElementById('studentAnswer').value,
                score: parseInt(document.getElementById('score').value),
                comments: document.getElementById('comments').value,
                language: document.getElementById('language').value,
                annotations: [...annotations] // 包含起始位置信息
            };

            localStorage.setItem('currentAssignment', JSON.stringify(formData));
        }

        // 加载当前表单数据
        function loadCurrentFormData() {
            const formData = localStorage.getItem('currentAssignment');


            if (formData) {
                const data = JSON.parse(formData);

                document.getElementById('studentName').value = data.studentName;
                document.getElementById('originalQuestion').value = data.originalQuestion;
                document.getElementById('standardAnswer').value = data.standardAnswer;
                document.getElementById('studentAnswer').value = data.studentAnswer;
                document.getElementById('score').value = data.score;
                document.getElementById('comments').value = data.comments;
                document.getElementById('language').value = data.language;
                annotations = data.annotations || [];

                // 更新评分显示
                updateScoreDisplay();

                // 更新批注列表
                renderAnnotations();
            }
        }

        // 删除单条历史记录
        function deleteAssignment(index) {
            if (confirm('确定要删除这条历史记录吗？此操作不可恢复！')) {
                historyAssignments.splice(index, 1);
                localStorage.setItem('assignmentHistory', JSON.stringify(historyAssignments));
                renderHistory();
                showNotification('成功', '历史记录已删除', 'success');
            }
        }

        // 导出到Excel：仅导出历史记录最终结果（一条记录一行，不含批注过程）
        function exportToExcel() {
            if (historyAssignments.length === 0) {
                showNotification('提示', '没有历史记录可导出', 'info');
                return;
            }

            // 准备导出数据：每条历史记录导出一行（最终值），包含批注信息
            const exportData = historyAssignments.map((assignment, assignmentIndex) => {
                // 处理批注信息
                let annotationContent = '';
                let annotationPositions = '';

                if (assignment.annotations && assignment.annotations.length > 0) {
                    annotationContent = assignment.annotations.map(annotation =>
                        `${annotation.type}: ${annotation.text}`
                    ).join('; ');
                    annotationPositions = assignment.annotations.map(annotation =>
                        `${annotation.type}: ${annotation.startPosition}-${annotation.range.end}`
                    ).join('; ');
                }

                return {
                    '作业序号': assignmentIndex + 1,
                    '语料名称': assignment.studentName,
                    '语种': assignment.language,
                    '评分': assignment.score,
                    '原文': assignment.originalQuestion,
                    '修订译文': assignment.standardAnswer,
                    '待修订译文': assignment.studentAnswer,
                    '批注内容': annotationContent,
                    '批注位置': annotationPositions,
                    '评语': assignment.comments,
                    '保存时间': assignment.savedTime
                };
            });

            // 创建工作簿和工作表
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(exportData);

            // 添加工作表到工作簿
            XLSX.utils.book_append_sheet(wb, ws, '作业记录');

            // 生成Excel文件并下载
            XLSX.writeFile(wb, '作业记录.xlsx');

            showNotification('成功', 'Excel文件已导出（包含批注信息）', 'success');
        }

        // 清空历史记录
        function clearHistory() {
            if (confirm('确定要清空所有历史记录吗？此操作不可恢复！')) {
                historyAssignments = [];
                localStorage.removeItem('assignmentHistory');
                renderHistory();
                showNotification('成功', '历史记录已清空', 'success');
            }
        }

        // 显示通知
        function showNotification(title, message, type) {
            notificationTitle.textContent = title;
            notificationMessage.textContent = message;

            // 设置图标和颜色
            if (type === 'success') {
                notificationIcon.className = 'fa fa-check-circle text-green-500';
            } else if (type === 'error') {
                notificationIcon.className = 'fa fa-exclamation-circle text-red-500';
            } else if (type === 'info') {
                notificationIcon.className = 'fa fa-info-circle text-blue-500';
            } else if (type === 'warning') {
                notificationIcon.className = 'fa fa-exclamation-triangle text-yellow-500';
            }

            // 显示通知
            notification.classList.remove('translate-y-20', 'opacity-0');

            // 3秒后自动隐藏
            setTimeout(hideNotification, 3000);
        }

        // 隐藏通知
        function hideNotification() {
            notification.classList.add('translate-y-20', 'opacity-0');
        }

        // 初始化应用
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>